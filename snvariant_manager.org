#+TITLE:  Variant Manager Configuration
#+AUTHOR: Xavier Garrido
#+DATE:   2015-07-21
#+OPTIONS: ^:{}
#+STARTUP: entitiespretty

* Introduction

The variant concept has been introduced in order to define "variable" parameters
for configuration files. Basic idea is to set a number of parameters that will
be used within configuration files such as vertex or genbb generator names. Then
it is possible to change their respective values in the command line, for
instance.

* Manager configuration
:PROPERTIES:
:TANGLE: snvariant_manager.conf
:END:

#+BEGIN_SRC shell
  #@config The main configuration parameters for the application variant repository

  #@description The organization name
  organization : string = "SuperNEMO"

  #@description The application name
  application  : string = "SN@ilWare"

  #@description The list of configuration files for embedded registries
  registries.config : string[1] as path = \
    "@SNEMO_SIMULATION_CONFIGURATION@/snvariant_core_registry.conf"

  #@description The lock request
  lock : boolean = true
#+END_SRC

* Registries
:PROPERTIES:
:TANGLE: snvariant_core_registry.conf
:END:

#+BEGIN_SRC shell
  #@config The configuration for the core variant registry

  #@description The name of the registry
  name : string = "core"

  #@description The display name of the registry
  display_name : string = "Core"

  #@description A short description
  terse_description : string = "The core application parameters"

  #@description Logging priority
  logging.priority : string = "fatal"

  #@description The variant model to be used as the default top variant
  top_variant_name : string = "core.VM"

  # #@description The list of prefixes for preserving some auxiliary properties
  # preserved_property_prefixes : string[2] = "CMS." "DB."

  #@description The list of files containing the definition of variant/parameter models
  configuration_items.files : string[2] as path =  \
    "@datatools:variants/models/base_variants.def" \
    "@SNEMO_SIMULATION_CONFIGURATION@/snvariant_core_variants.def"
#+END_SRC

* Variant definitions
** Core variants
:PROPERTIES:
:TANGLE: snvariant_core_variants.def
:END:

*** Vertex generators

#+NAME: vg_list_variants
#+BEGIN_SRC shell :tangle no :results output
  cnt=0
  falaise_dir=$SNAILWARE_PRO_DIR/falaise/install/share/Falaise-1.0.0/resources
  files=$(cat current/sngenvertex_manager.conf | grep '".*/.*"' | awk -F \" '{print $2}')
  for if in ${=files}; do
      file=${if/@falaise:/${falaise_dir}\/}
      vgs=$(cat $file | grep 'genvtx::.*_vg' | awk -F \" '{print $2}')
      for ivg in ${=vgs}; do
          echo "string.enumerated_${cnt}.value : string = \"${ivg}\""
          let cnt++
      done
  done
  echo "string.enumerated.size : integer = ${cnt}"
#+END_SRC

#+BEGIN_SRC shell :noweb yes
  [name="vertex_generator_name.PM" type="parameter"]
  display_name              : string = "Vertex generator name"
  description               : string = "The name of the vertex generator"
  type                      : string = "string"
  mutability                : string = "variable"
  variable.mode             : string = "enumeration"
  <<vg_list_variants()>>
#+END_SRC

*** Event generators

#+NAME: eg_list_variants
#+BEGIN_SRC shell :tangle no :results output
  cnt=0
  falaise_dir=$SNAILWARE_PRO_DIR/falaise/install/share/Falaise-1.0.0/resources
  files=$(cat current/sngenbb_manager.conf | grep '".*/.*"' | awk -F \" '{print $2}')
  for if in ${=files}; do
      file=${if/@falaise:/${falaise_dir}\/}
      egs=$(cat $file | grep 'genbb::' | awk -F \" '{print $2}')
      for ieg in ${=egs}; do
          echo "string.enumerated_${cnt}.value : string = \"${ieg}\""
          let cnt++
      done
  done
  echo "string.enumerated.size : integer = ${cnt}"
#+END_SRC

#+BEGIN_SRC shell :noweb yes
  [name="event_generator_name.PM" type="parameter"]
  display_name              : string = "Event generator name"
  description               : string = "The name of the genbb event generator"
  type                      : string = "string"
  mutability                : string = "variable"
  variable.mode             : string = "enumeration"
  <<eg_list_variants()>>
#+END_SRC

*** Top variant
#+BEGIN_SRC shell
  [name="core.VM" type="variant"]

  #@config A variant model describing the parameters for the core application

  #@description The display name of this variant
  display_name : string = "Core setup"

  #@description A short description of the variant
  terse_description : string = "The configuration parameters for the core application"

  #@description The list of variant parameters
  parameters : string[2] = "vg" "eg"

  parameters.vg.model : string = "vertex_generator_name.PM"
  parameters.eg.model : string = "event_generator_name.PM"
#+END_SRC
